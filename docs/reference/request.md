# Request Object

```javascript
const routing = require('spife/routing')
const spife = require('spife')
const http = require('http')

spife('example', http.createServer(), routing`
  GET /some/path      exampleView
`({
  exampleView (request, context) {
    request // <--
  }
}))
```

A `Request` object is passed to user-defined [views][topic-http-view] as the
first parameter. It corresponds to a client request for a given route. It gates
access to a backing [`http.IncomingMessage`][def-incoming-message] object
generated by Node, in order to safely control access to the body of the
request.

> :information\_source: **`Request` is not an `EventEmitter`**
>
> Unlike the `IncomingMessage` object provided by Node servers directly,
> requests coming in from Spife are _not_ `EventEmitter` instances!

## Table of Contents

* [API](#api)
  * [Methods](#methods)

    * [request.accept → Accept](#requestaccept--accept)
    * [request.body → Promise&lt;Object|null>](#requestbody--promiseobjectnull)
    * [request.cookie(name) → null|String](#requestcookiename--nullstring)
    * [request.cookies() → null|Object](#requestcookies--nullobject)
    * [request.getRanges(size) → Ranges](#requestgetrangessize--ranges)
    * [request.headers → Object&lt;String : String>](#requestheaders--objectstring--string)
    * [request.httpVersion → String](#requesthttpversion--string)
    * [request.id → String](#requestid--string)
    * [request.method → String](#requestmethod--string)
    * [request.pipe(dst)](#requestpipedst)
    * [request.query → Object&lt;String : String>](#requestquery--objectstring--string)
    * [request.raw → http.IncomingMessage](#requestraw--httpincomingmessage)
    * [request.rawHeaders → Array&lt;Array&lt;String, String>>](#requestrawheaders--arrayarraystring-string)
    * [request.remoteAddress → String](#requestremoteaddress-string)
    * [request.remoteFamily → String](#requestremotefamily-string)
    * [request.remotePort → Number](#requestremoteport-number)
    * [request.url → String](#requesturl--string)
    * [request.urlObject → URL](#requesturlobject--url)
    * [request.viewName → String](#requestviewname--string)

## API

### Methods

#### `request.accept → Accept`

Get an accept object for the request, per the [accepts package][pkg-accepts].

```javascript
'use strict'

const reply = require('spife/reply')

module.exports = function myView (req, context) {
  switch (req.accept.type(['json', 'html'])) {
    case 'json':
      return {"some": "data"}
    case 'html':
      return header('<p>OK</p>', 'content-type', 'text/html')
  }
  return 'well, I guess you just want plaintext.'
}
```

#### `request.body → Promise<Object|null>`

Attempt to fetch the body as JSON. Fails if the body has been disabled (by
acccessing `.raw` or `.pipe`), if the request is too large, or if the body does
not represent JSON. The value will be cached for future use. If the request did
not provide a body, this promise will resolve to `null`.

The body will not be consumed until this property is accessed.

```javascript
'use strict'

const reply = require('spife/reply')

module.exports = function myView (req, context) {
  return req.body.then(data => {
    data.someProperty // yep, it's JSON!
  }).catch(reply.PayloadTooLargeError, err => {
    // user sent us too much data!
    throw err
  }).catch(reply.BadRequestError, err => {
    // user sent us bad JSON!
    throw err
  })
}
```

#### `request.cookie(name) → null|String`

Returns the request cookie identified by `name`.

#### `request.cookies() → null|Object`

Returns the request cookie object, if present.

#### `request.getRanges(size) → Ranges`

Parse the "Range" header into a [series of ranges][pkg-range-parser].

#### `request.headers → Object<String : String>`

Get [the `IncomingMessage` headers][def-http-headers].

#### `request.httpVersion → String`

Get [the HTTP Version, per `IncomingMessage`][def-http-version].

#### `request.id → String`

A per-request base64'd uuid. If the spife server [is marked as
internal][ref-spife-options-internal], then the request ID will be populated by
the [request ID headers][ref-spife-options-headers]. If the server is external,
incoming headers will be hashed and a unique ID will be appended.

The [logging middleware][ref-middleware-logging] will automatically included
the request ID in all log output.

#### `request.method → String`

Get the [original request method, per `IncomingMessage`][def-http-method].

#### `request.pipe(dst)`

Pipe the `IncomingMessage` request to a destination. Disables automatic body
parsing support.

```javascript
'use strict'
const concat = require('concat-stream')

module.exports = function myView (req, context) {
  return new Promise(resolve => {
    req.pipe(concat(data => {
      resolve('OK!')
    }))

    req.body.catch(err => {
      err.message // 'Cannot read the body if "raw" has been accessed'
    })
  })
}
```

#### `request.query → Object<String : String>`

Get the query portion of the URL, [as returned by
`querystring.parse`][def-querystring-parse].

```javascript
'use strict'

// assuming we were called with "/?page=3"
module.exports = function myView (req, context) {
  console.log(req.query.page) // "3"
  return 'oh wow'
}
```

#### `request.raw → http.IncomingMessage`

Get the original request. Disables automatic body parsing support.

#### `request.rawHeaders → Array<Array<String, String>>`

Get the [raw headers, per `IncomingMessage`][def-http-raw-headers].

#### `request.remoteAddress → String`

The string representation of the remote IP address. For example,
'74.125.127.100' or '2001:4860:a005::68'.

#### `request.remoteFamily → String`

The string representation of the remote IP family. `'IPv4'` or `'IPv6'`.

#### `request.remotePort → Number`

The numeric representation of the remote port. For example, `80` or `21`.

#### `request.url → String`

Get the string representing the full URL.

#### `request.urlObject → URL`

Get the fully parsed request url, [as returned by `url.parse(req,
true)`][def-url-parse].

```javascript
'use strict'

module.exports = function myView (req, context) {
  console.log(req.urlObject.pathname)
  return 'neat.'
}
```

#### `request.viewName → String`

Get the dot-delimited view path, suitable for passing to `routes.reverse`.

```javascript
'use strict'

const routes = require('../path/to/my/apps/routes')

module.exports = function myView (req, context) {
  return routes.reverse(req.viewName)
}
```

[def-http-headers]: https://nodejs.org/api/http.html#http_message_headers

[def-http-method]: https://nodejs.org/api/http.html#http_message_method

[def-http-raw-headers]: https://nodejs.org/api/http.html#http_message_rawheaders

[def-http-version]: https://nodejs.org/api/http.html#http_message_httpversion

[def-incoming-message]: https://nodejs.org/api/http.html#http_class_http_incomingmessage

[def-querystring-parse]: https://nodejs.org/api/querystring.html#querystring_querystring_parse_str_sep_eq_options

[def-url-parse]: https://nodejs.org/api/url.html#url_url_parsing

[pkg-accepts]: https://github.com/jshttp/accepts#api

[pkg-range-parser]: https://github.com/jshttp/range-parser#api

[ref-spife-options-headers]: ./server.md#optionsrequestidheaders

[ref-spife-options-internal]: ./server.md#optionsisexternal

[ref-middleware-logging]: ./middleware/logging.md

[topic-http-view]: ../topics/request-lifecycle.md#four-view-execution
